name: CI/CD - Test, Build, and Push Docker Images

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # Job para ejecutar las pruebas
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install backend dependencies and run tests
        # Nos movemos al directorio del backend para ejecutar los comandos
        working-directory: ./10-calendar-backend
        run: |
          npm install
          # Aseg√∫rate de tener un script "test" en tu package.json del backend
          npm test

      - name: Install frontend dependencies and run tests
        # Nos movemos al directorio del frontend para ejecutar los comandos
        working-directory: ./10-calendar
        run: |
          npm install
          # El comando 'npm test -- --watchAll=false' ejecuta Jest una vez sin modo de espera
          npm test -- --watchAll=false

  # Job para construir y publicar la imagen del Backend
  build-and-push-backend:
    # Este job ahora necesita que el job 'run-tests' termine exitosamente
    needs: run-tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v4
        with:
          context: ./10-calendar-backend
          file: ./10-calendar-backend/Dockerfile
          push: true
          tags: edwardsalinas/calendar-backend:latest

  # Job para construir y publicar la imagen del Frontend
  build-and-push-frontend:
    # La cadena de dependencias se mantiene: frontend depende de backend, que a su vez depende de las pruebas
    needs: build-and-push-backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v4
        with:
          context: ./10-calendar
          file: ./10-calendar/Dockerfile
          push: true
          tags: edwardsalinas/calendar-frontend:latest
